This is based on commit 


c14f14eeaf919c914e4dec2ce485a5bdc8dd4fec


of nixpkgs master. 

PLEASE UPDATE ME TO BE ABLE TO EASILY DIFF OUT THE CHANGES WHEN YOU REBASE ME.
